---
import { smallSponsors as originalSmallSponsors } from "../data/smallSponsors";
import { Image } from "astro:assets";
import codext from "../images/codext.jpg";
import reshot from "../images/reshotai.png";
import web3jobs from "../images/web3jobs.png";

// Shuffle function to randomize sponsor order
function shuffleArray(array) {
    // Create a copy of the array to avoid mutating the original
    const shuffled = [...array];

    // Fisher-Yates shuffle algorithm
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    return shuffled;
}

// Randomize small sponsors
const smallSponsors = shuffleArray(originalSmallSponsors);
---

<div class="py-4">
    <div class="flex flex-col items-center gap-2">
        <div class="embla-small">
            <div class="embla-small__container">
                {
                    smallSponsors.map((sponsor) =>
                        sponsor.isSpecial && sponsor.imageUrl === "question" ? (
                            <div class="embla-small__slide">
                                <a
                                    class="w-12 h-12 border border-warning font-bold border-dashed hover:bg-warning hover:text-black flex justify-center text-center items-center text-3xl text-white animate-pulse"
                                    href={sponsor.url}
                                >
                                    ?!
                                </a>
                            </div>
                        ) : sponsor.isSpecial &&
                          sponsor.imageUrl === "runpod-svg" ? (
                            <div class="embla-small__slide">
                                <a href={sponsor.url}>
                                    <svg
                                        class="w-11 h-11 fill-[#824edc] bg-white rounded"
                                        xmlns="http://www.w3.org/2000/svg"
                                        version="1.0"
                                        viewBox="0 0 200 200"
                                    >
                                        <g>
                                            <path d="M74.5 51.1c-25.4 14.9-27 16-29.6 20.2-1.8 3-1.9 5.3-1.9 32.3 0 21.7.3 29.4 1.3 30.6 1.9 2.5 46.7 27.9 48.5 27.6 1.5-.3 1.7-3.1 2-27.7.2-21.9 0-27.8-1.1-29.5-.8-1.2-9.9-6.8-20.2-12.6-10.3-5.8-19.4-11.5-20.2-12.7-1.8-2.6-.9-5.9 1.8-7.4 1.6-.8 6.3 0 21.8 4C87.8 78.7 98 81 99.6 81c4.4 0 49.9-25.9 49.9-28.4 0-1.6-3.4-2.8-24-8.2-13.2-3.5-25.1-6.3-26.5-6.3-1.4.1-12.4 5.9-24.5 13z" />
                                            <path d="m137.2 68.1-3.3 2.1 6.3 3.7c3.5 2 6.3 4.3 6.3 5.1 0 .9-8 6.1-19.4 12.6-10.6 6-20 11.9-20.7 12.9-1.2 1.6-1.4 7.2-1.2 29.4.3 24.8.5 27.6 2 27.9 1.8.3 46.6-25.1 48.6-27.6.9-1.2 1.2-8.8 1.2-30.2s-.3-29-1.2-30.2c-1.6-1.9-12.1-7.8-13.9-7.8-.8 0-2.9 1-4.7 2.1z" />
                                        </g>
                                    </svg>
                                </a>
                            </div>
                        ) : sponsor.imageUrl === "../images/web3jobs.png" ? (
                            <div class="embla-small__slide">
                                <a href={sponsor.url}>
                                    <Image
                                        class={sponsor.customStyle || ""}
                                        src={web3jobs}
                                        width={sponsor.width || 45}
                                        height={sponsor.height || 45}
                                        loading="eager"
                                        alt={sponsor.name}
                                    />
                                </a>
                            </div>
                        ) : sponsor.imageUrl === "../images/reshotai.png" ? (
                            <div class="embla-small__slide">
                                <a href={sponsor.url}>
                                    <Image
                                        class={sponsor.customStyle || ""}
                                        src={reshot}
                                        width={sponsor.width || 45}
                                        height={sponsor.height || 45}
                                        loading="eager"
                                        alt={sponsor.name}
                                    />
                                </a>
                            </div>
                        ) : sponsor.imageUrl === "../images/codext.jpg" ? (
                            <div class="embla-small__slide">
                                <a href={sponsor.url}>
                                    <Image
                                        class={sponsor.customStyle || ""}
                                        src={codext}
                                        width={sponsor.width || 45}
                                        height={sponsor.height || 45}
                                        loading="eager"
                                        alt={sponsor.name}
                                    />
                                </a>
                            </div>
                        ) : (
                            <div class="embla-small__slide">
                                <a href={sponsor.url}>
                                    <img
                                        class={sponsor.customStyle || ""}
                                        src={sponsor.imageUrl}
                                        width={sponsor.width || 45}
                                        height={sponsor.height || 45}
                                        loading="eager"
                                        alt={sponsor.name}
                                    />
                                </a>
                            </div>
                        ),
                    )
                }
            </div>
        </div>
    </div>
    <div class="text-center pt-4">
        <a
            class="text-warning underline text-xs hover:text-white"
            href="https://github.com/sponsors/coollabsio"
        >
            ...and many more...
        </a>
    </div>
</div>
<script>
    import EmblaCarousel from "embla-carousel";
    import type { EmblaOptionsType } from "embla-carousel";
    import AutoScroll from "embla-carousel-auto-scroll";

    const skipButton = document.getElementById("skip-to-features");
    const sponsorsSection = document.getElementById("sponsors-section");
    const featuresSection = document.getElementById("features");
    const mainContent = document.querySelector("main");

    if (skipButton && sponsorsSection && featuresSection && mainContent) {
        const showSkipButton = () => {
            skipButton.style.opacity = "1";
            skipButton.style.pointerEvents = "auto";
        };

        const hideSkipButton = () => {
            skipButton.style.opacity = "0";
            skipButton.style.pointerEvents = "none";
        };

        // Show button at the top of the page
        const topObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting && window.scrollY < 200) {
                        showSkipButton();
                    }
                });
            },
            { threshold: 1.0 },
        );

        // Show button in sponsors section
        const sponsorsObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        showSkipButton();
                    }
                });
            },
            { threshold: 0.1 },
        );

        // Hide button when features section is visible
        const featuresObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        hideSkipButton();
                    }
                });
            },
            { threshold: 0.1 },
        );

        topObserver.observe(mainContent);
        sponsorsObserver.observe(sponsorsSection);
        featuresObserver.observe(featuresSection);

        skipButton.addEventListener("click", () => {
            featuresSection.scrollIntoView({ behavior: "smooth" });
        });

        // Also show button when user is at the very top of the page
        window.addEventListener("scroll", () => {
            if (window.scrollY < 200) {
                showSkipButton();
            } else if (
                sponsorsSection.getBoundingClientRect().top >=
                window.innerHeight
            ) {
                hideSkipButton();
            }
        });
    }

    // Small sponsors carousel implementation
    const emblaSmallNode = document.querySelector(
        ".embla-small",
    ) as HTMLElement;
    if (emblaSmallNode) {
        // Set up Embla options for small sponsors
        const smallOptions: EmblaOptionsType = {
            loop: true,
            containScroll: "trimSnaps",
            slidesToScroll: 1,
            skipSnaps: false,
            watchDrag: true,
        };

        // Set up auto-scroll options
        const smallAutoScrollOptions = {
            speed: 1,
            stopOnInteraction: false,
            stopOnMouseEnter: true,
            playOnInit: false,
        };

        // Initialize Embla Carousel with auto-scroll plugin
        const emblaSmallApi = EmblaCarousel(emblaSmallNode, smallOptions, [
            AutoScroll(smallAutoScrollOptions),
        ]);

        // Start auto-scroll after a small delay to ensure proper initialization
        setTimeout(() => {
            emblaSmallApi.plugins().autoScroll.play();
        }, 300);
    }
</script>

<style>
    .embla-small {
        overflow: hidden;
        max-width: 100%;
        margin: 0 auto;
        position: relative;
    }

    .embla-small__container {
        display: flex;
        backface-visibility: hidden;
        will-change: transform;
        touch-action: pan-y;
    }

    .embla-small__slide {
        flex: 0 0 auto;
        min-width: 0;
        position: relative;
        padding: 0 0.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
    }

    .rainbow-border {
        position: relative;
        border-radius: 200px;
        padding: 0rem;
    }

    .rainbow-border::before {
        content: "";
        position: absolute;
        top: 6px;
        left: 6px;
        right: 6px;
        bottom: 6px;
        background: conic-gradient(
            #ff2400,
            #e81d1d,
            #e8b71d,
            #e3e81d,
            #1de840,
            #1ddde8,
            #2b1de8,
            #dd00f3,
            #ff2400
        );
        border-radius: 200px;
        z-index: -1;
        animation: rotate 1s linear infinite;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
</style>
